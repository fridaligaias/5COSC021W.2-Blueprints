{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky - Department Leader Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static '/summary/summary.css' %}">
</head>
<body>
    <!-- Header with Sky logo -->
    <header class="header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <img src="{% static 'Sky_Group_logo_2020.png' %}" alt="Sky Group Logo" class="sky-logo">
                </div>
                <div class="col text-end d-flex justify-content-end align-items-center">
                    <svg width="60" height="30" viewBox="0 0 60 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.5 5C10.2533 5 6 9.2533 6 14.5C6 19.7467 10.2533 24 15.5 24H44.5C49.7467 24 54 19.7467 54 14.5C54 9.2533 49.7467 5 44.5 5H15.5Z" fill="#FF3366"/>
                        <path d="M17.5 10.5V18.5H20V15.8333H21.1667C22.9167 15.8333 24 14.9167 24 13.1667C24 11.4167 22.9167 10.5 21.1667 10.5H17.5ZM20 13.6667V12.6667H20.8333C21.3333 12.6667 21.5 12.8333 21.5 13.1667C21.5 13.5 21.3333 13.6667 20.8333 13.6667H20Z" fill="white"/>
                        <path d="M25 10.5V18.5H27.5L27.6667 17.8333C28 18.3333 28.5833 18.6667 29.3333 18.6667C30.9167 18.6667 32 17.4167 32 14.75C32 12.25 31 10.3333 29.25 10.3333C28.5833 10.3333 28 10.6667 27.6667 11.1667L27.5 10.5H25ZM27.5 14.6667C27.5 13.5 27.8333 12.8333 28.4167 12.8333C29 12.8333 29.3333 13.5 29.3333 14.5833C29.3333 15.8333 29 16.1667 28.4167 16.1667C27.8333 16.1667 27.5 15.6667 27.5 14.6667Z" fill="white"/>
                        <path d="M38 11.8333L37.6667 10.5H35.1667V18.5H37.8333V14.4167C37.8333 13.5 38.8333 13.1667 39.4167 13.1667L40 13.25L40.3333 10.5833C39.5 10.4167 38.5 10.8333 38 11.8333Z" fill="white"/>
                    </svg>
                    <a href="{% url 'logout' %}" class="btn btn-outline-danger ms-3">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </header>
<body>
    
    <!-- Main content -->
    <div class="main-content">
        <div class="container">
            <h1 class="page-title">Department Leader Dashboard</h1>
            
            {% if departments_data %}
                {% for dept_data in departments_data %}
                    <div class="card mb-5">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="h4 mb-0">Department: {{ dept_data.department.departmentName }}</h2>
                                <button type="button" class="badge bg-secondary border-0" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deptMembersModal-{{ dept_data.department.departmentID }}">
                                    {{ dept_data.members_count }} members
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Department Summary -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="h5">Teams</h3>
                                            <p class="display-4">{{ dept_data.teams_count }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="h5">Sessions</h3>
                                            <p class="display-4">{{ dept_data.sessions_count }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="h5">Cards</h3>
                                            <p class="display-4">{{ dept_data.cards_count }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="h5">Completion</h3>
                                            <p class="display-4">{{ dept_data.completion|floatformat:1 }}%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Department Progress Bar -->
                            <div class="row mb-4">
                                <div class="col">
                                    <h3 class="h5">Overall Progress</h3>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar" role="progressbar" 
                                            style="width: {{ dept_data.completion }}%;" 
                                            aria-valuenow="{{ dept_data.completion }}" 
                                            aria-valuemin="0" aria-valuemax="100">
                                            {{ dept_data.completion|floatformat:1 }}%
                                        </div>
                                    </div>
                                    <div class="text-end mt-1">
                                        <small class="text-muted">
                                            {{ dept_data.votes_count }} / {{ dept_data.possible_votes }} votes completed
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Teams Progress -->
                            <h3 class="h5 mb-3">Teams Progress</h3>
                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
                                {% for team_data in dept_data.teams %}
                                    <div class="col">
                                        <div class="card h-100">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="h6 mb-0">{{ team_data.team.teamName }}</h4>
                                                    <span class="badge bg-secondary">{{ team_data.members_count }} members</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <!-- Team Summary -->
                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Sessions</small>
                                                        <strong>{{ team_data.sessions_count }}</strong>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Cards</small>
                                                        <strong>{{ team_data.cards_count }}</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Team Progress Bar -->
                                                <div class="progress mb-3" style="height: 15px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                        style="width: {{ team_data.completion }}%;" 
                                                        aria-valuenow="{{ team_data.completion }}" 
                                                        aria-valuemin="0" aria-valuemax="100">
                                                        {{ team_data.completion|floatformat:1 }}%
                                                    </div>
                                                </div>
                                                <div class="text-end mb-3">
                                                    <small class="text-muted">
                                                        {{ team_data.votes_count }} / {{ team_data.possible_votes }} votes
                                                    </small>
                                                </div>
                                                
                                                <!-- Recent Sessions -->
                                                {% if team_data.recent_sessions %}
                                                    <h5 class="h6 mt-3">Recent Sessions</h5>
                                                    <ul class="list-group list-group-flush">
                                                        {% for session in team_data.recent_sessions %}
                                                            <li class="list-group-item px-0">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span>{{ session.session.sessionName }}</span>
                                                                    <span class="badge bg-info">
                                                                        {{ session.completion|floatformat:1 }}%
                                                                    </span>
                                                                </div>
                                                                <div class="progress mt-1" style="height: 5px;">
                                                                    <div class="progress-bar" role="progressbar" 
                                                                        style="width: {{ session.completion }}%;" 
                                                                        aria-valuenow="{{ session.completion }}" 
                                                                        aria-valuemin="0" aria-valuemax="100">
                                                                    </div>
                                                                </div>
                                                                <small class="text-muted">
                                                                    {{ session.votes_count }} / {{ session.possible_votes }} votes
                                                                </small>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="alert alert-info mt-3">
                                                        No recent sessions for this team.
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- View Details Button - Updated to open a modal -->
                                                <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-3" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#teamDetailsModal-{{ team_data.team.teamID }}">
                                                    View Team Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Modal for Team Details -->
                                    <div class="modal fade" id="teamDetailsModal-{{ team_data.team.teamID }}" tabindex="-1" 
                                         aria-labelledby="teamDetailsModalLabel-{{ team_data.team.teamID }}" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="teamDetailsModalLabel-{{ team_data.team.teamID }}">
                                                        {{ team_data.team.teamName }} - Team Details
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Team Information -->
                                                    <div class="row mb-4">
                                                        <div class="col-md-6">
                                                            <h6>Team Information</h6>
                                                            <ul class="list-group">
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Team ID:</span>
                                                                    <strong>{{ team_data.team.teamID }}</strong>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Department:</span>
                                                                    <strong>{{ team_data.team.departmentID.departmentName }}</strong>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Team Members:</span>
                                                                    <strong>{{ team_data.members_count }}</strong>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Sessions:</span>
                                                                    <strong>{{ team_data.sessions_count }}</strong>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Cards:</span>
                                                                    <strong>{{ team_data.cards_count }}</strong>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between">
                                                                    <span>Completion:</span>
                                                                    <strong>{{ team_data.completion|floatformat:1 }}%</strong>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6>Team Members</h6>
                                                            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                                                <table class="table table-sm">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Name</th>
                                                                            <th>Email</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for member in dept_data.member_list %}
                                                                            <tr>
                                                                                <td>{{ member.full_name }}</td>
                                                                                <td>{{ member.email }}</td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Team Sessions -->
                                                    <h6>All Sessions</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Session Name</th>
                                                                    <th>Start Date</th>
                                                                    <th>End Date</th>
                                                                    <th>Cards</th>
                                                                    <th>Completion</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for session in team_data.recent_sessions %}
                                                                <tr>
                                                                    <td>{{ session.session.sessionName }}</td>
                                                                    <td>{{ session.session.sessionStartData|date:"M d, Y" }}</td>
                                                                    <td>{{ session.session.sessionEndData|date:"M d, Y" }}</td>
                                                                    <td>{{ session.cards_count }}</td>
                                                                    <td>
                                                                        <div class="progress" style="height: 10px;">
                                                                            <div class="progress-bar" role="progressbar" 
                                                                                style="width: {{ session.completion }}%;" 
                                                                                aria-valuenow="{{ session.completion }}" 
                                                                                aria-valuemin="0" aria-valuemax="100">
                                                                            </div>
                                                                        </div>
                                                                        <small>{{ session.completion|floatformat:1 }}%</small>
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End Modal for Team Details -->
                                    
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal for Department Members -->
                    <div class="modal fade" id="deptMembersModal-{{ dept_data.department.departmentID }}" tabindex="-1" aria-labelledby="deptMembersModalLabel-{{ dept_data.department.departmentID }}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deptMembersModalLabel-{{ dept_data.department.departmentID }}">{{ dept_data.department.departmentName }} - Department Members</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <ul class="list-group">
                                        {% for member in dept_data.member_list %}
                                            <li class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ member.full_name }}</strong>
                                                        <div class="small text-muted">{{ member.email }}</div>
                                                    </div>
                                                </div>
                                            </li>
                                        {% empty %}
                                            <li class="list-group-item">No members found in this department</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Modal for Department Members -->
                    
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    No departments found or you don't have permission to view any departments.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="row">
                <div class="col-md-6">
                    <h5>Sky Assessment</h5>
                    <p>Monitor department and team assessment progress in real-time.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2025 Sky Group</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
</body>
</html>