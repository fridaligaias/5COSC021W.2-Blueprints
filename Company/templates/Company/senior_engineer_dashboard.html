{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky - Senior Engineer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static '/summary/summary.css' %}">
</head>
<body>
    <!-- Header with Sky logo -->
    <header class="header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <img src="{% static 'Sky_Group_logo_2020.png' %}" alt="Sky Group Logo" class="sky-logo">
                </div>
                <div class="col text-end">
                    <svg width="60" height="30" viewBox="0 0 60 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.5 5C10.2533 5 6 9.2533 6 14.5C6 19.7467 10.2533 24 15.5 24H44.5C49.7467 24 54 19.7467 54 14.5C54 9.2533 49.7467 5 44.5 5H15.5Z" fill="#FF3366"/>
                        <path d="M17.5 10.5V18.5H20V15.8333H21.1667C22.9167 15.8333 24 14.9167 24 13.1667C24 11.4167 22.9167 10.5 21.1667 10.5H17.5ZM20 13.6667V12.6667H20.8333C21.3333 12.6667 21.5 12.8333 21.5 13.1667C21.5 13.5 21.3333 13.6667 20.8333 13.6667H20Z" fill="white"/>
                        <path d="M25 10.5V18.5H27.5L27.6667 17.8333C28 18.3333 28.5833 18.6667 29.3333 18.6667C30.9167 18.6667 32 17.4167 32 14.75C32 12.25 31 10.3333 29.25 10.3333C28.5833 10.3333 28 10.6667 27.6667 11.1667L27.5 10.5H25ZM27.5 14.6667C27.5 13.5 27.8333 12.8333 28.4167 12.8333C29 12.8333 29.3333 13.5 29.3333 14.5833C29.3333 15.8333 29 16.1667 28.4167 16.1667C27.8333 16.1667 27.5 15.6667 27.5 14.6667Z" fill="white"/>
                        <path d="M38 11.8333L37.6667 10.5H35.1667V18.5H37.8333V14.4167C37.8333 13.5 38.8333 13.1667 39.4167 13.1667L40 13.25L40.3333 10.5833C39.5 10.4167 38.5 10.8333 38 11.8333Z" fill="white"/>
                    </svg>
                    <a href="{% url 'logout' %}" class="btn btn-outline-danger ms-3">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main content -->
    <div class="main-content">
        <div class="container">
            <h1 class="page-title">Senior Engineer Dashboard</h1>
            
            {% if departments_data %}
                {% for department in departments_data %}
                    <div class="card department-card mb-4">
                        <div class="department-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="department-title">
                                    <i class="bi bi-building me-2"></i>
                                    {{ department.departmentName }}
                                </h2>
                                <span class="badge bg-secondary">{{ department.teams|length }} teams</span>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if department.teams %}
                                <div class="accordion" id="accordion-department-{{ department.departmentID }}">
                                    {% for team_data in department.teams %}
                                        <div class="card team-card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h3 class="h5 mb-0">
                                                        <i class="bi bi-people me-2"></i>
                                                        Team: {{ team_data.team.teamName }}
                                                    </h3>
                                                    <span class="badge bg-secondary">{{ team_data.members_count }} members</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                {% if team_data.sessions %}
                                                    <div class="accordion" id="accordion-team-{{ team_data.team.teamID }}">
                                                        {% for session_data in team_data.sessions %}
                                                            <div class="accordion-item mb-3">
                                                                <h4 class="accordion-header" id="heading-{{ session_data.session.sessionID }}">
                                                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                                                                            data-bs-toggle="collapse" 
                                                                            data-bs-target="#collapse-{{ session_data.session.sessionID }}" 
                                                                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                                                            aria-controls="collapse-{{ session_data.session.sessionID }}">
                                                                        <i class="bi bi-calendar-check me-2"></i>
                                                                        Session: {{ session_data.session.sessionName }} 
                                                                        <span class="ms-auto badge bg-info">
                                                                            {{ session_data.actual_votes }} / {{ session_data.potential_total_votes }} votes ({{ session_data.completion_percentage|floatformat:1 }}%)
                                                                        </span>
                                                                    </button>
                                                                </h4>
                                                                <div id="collapse-{{ session_data.session.sessionID }}" 
                                                                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                                                                     aria-labelledby="heading-{{ session_data.session.sessionID }}"
                                                                     data-bs-parent="#accordion-team-{{ team_data.team.teamID }}">
                                                                    <div class="accordion-body">
                                                                        <div class="row mb-3">
                                                                            <div class="col">
                                                                                <div class="progress">
                                                                                    <div class="progress-bar" role="progressbar" 
                                                                                        style="width: {{ session_data.completion_percentage }}%;" 
                                                                                        aria-valuenow="{{ session_data.completion_percentage }}" 
                                                                                        aria-valuemin="0" aria-valuemax="100">
                                                                                        {{ session_data.completion_percentage|floatformat:1 }}%
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="table-responsive">
                                                                            <table class="table table-hover">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th style="width: 10%">Card ID</th>
                                                                                        <th style="width: 20%">Green Description</th>
                                                                                        <th style="width: 20%">Amber Description</th>
                                                                                        <th style="width: 20%">Red Description</th>
                                                                                        <th style="width: 30%">Vote Status</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for card in session_data.cards_data %}
                                                                                        <tr>
                                                                                            <td>{{ card.card_id }}</td>
                                                                                            <td>{{ card.green_description }}</td>
                                                                                            <td>{{ card.amber_description }}</td>
                                                                                            <td>{{ card.red_description }}</td>
                                                                                            <td>
                                                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                                                    <div class="d-flex">
                                                                                                        <span class="badge bg-success me-1" data-bs-toggle="tooltip" title="Green Votes">
                                                                                                            {{ card.green_votes }}
                                                                                                        </span>
                                                                                                        <span class="badge bg-warning me-1" data-bs-toggle="tooltip" title="Amber Votes">
                                                                                                            {{ card.amber_votes }}
                                                                                                        </span>
                                                                                                        <span class="badge bg-danger" data-bs-toggle="tooltip" title="Red Votes">
                                                                                                            {{ card.red_votes }}
                                                                                                        </span>
                                                                                                    </div>
                                                                                                    <span class="ms-2 small">
                                                                                                        {{ card.voters_count }} / {{ team_data.members_count }} voted
                                                                                                    </span>
                                                                                                </div>
                                                                                                
                                                                                                <!-- Progress bar showing percentage of team members who voted -->
                                                                                                <div class="progress" style="height: 8px;">
                                                                                                    <div class="progress-bar" role="progressbar" 
                                                                                                        style="width: {{ card.voters_percentage }}%;" 
                                                                                                        aria-valuenow="{{ card.voters_percentage }}" 
                                                                                                        aria-valuemin="0" aria-valuemax="100">
                                                                                                    </div>
                                                                                                </div>
                                                                                                
                                                                                                <!-- Show number of pending votes -->
                                                                                                <div class="text-end mt-1">
                                                                                                    <small class="text-muted">
                                                                                                        {% if card.pending_votes > 0 %}
                                                                                                            {{ card.pending_votes }} members pending
                                                                                                        {% else %}
                                                                                                            All members voted
                                                                                                        {% endif %}
                                                                                                    </small>
                                                                                                </div>
                                                                                            </td>
                                                                                        </tr>
                                                                                    {% endfor %}
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info">
                                                        <i class="bi bi-info-circle me-2"></i>
                                                        No sessions found for this team.
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    No teams found in this department.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    No departments found or you don't have permission to view any departments.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="row">
                <div class="col-md-6">
                    <h5>Sky Assessment</h5>
                    <p>Monitor team assessment progress across departments in real-time.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2025 Sky Group</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
</body>
</html>